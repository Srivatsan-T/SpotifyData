# `pages.recents` – Recents Page

**File path:** `/app/cloned_repos/spotify_data/pages/recents.py`

The `recents` module implements a Dash page that displays the most recently played songs for a user.  
It is registered as a dynamic route (`/recents/<username>`) and is part of the navigation
system that also includes the *Liked Songs*, *Analytics*, and *Tools* pages.

---

## 1. Imports & Dependencies

| Import | Purpose | Notes |
|--------|---------|-------|
| `dash` | Core Dash framework | Provides `register_page` and `callback` decorator. |
| `dash import dcc, callback` | `dcc` for components, `callback` for callbacks | |
| `dash import html` | HTML component helpers | |
| `dash.dependencies import Input, Output, State` | Callback inputs/outputs | |
| `dash_bootstrap_components as dbc` | Bootstrap‑styled components | Used for the navigation bar and tables. |
| `pandas as pd` | Data manipulation | Converts query results to a DataFrame. |
| `math` | `ceil` for pagination | |
| `postgres` | Custom module for DB access | Provides `select_recent_songs`. |

> **Why the dependency on `postgres` exists**  
> The page needs to fetch recent song data from a PostgreSQL database.  
> `postgres.select_recent_songs(beg, end)` returns a list of tuples that represent rows in the
> `recent_songs` table.  The module relies on this function to populate the table shown to the user.

---

## 2. Page Registration

```python
dash.register_page(__name__, path_template='/recents/<username>')
```

* Registers the module as a Dash page.  
* The URL pattern `/recents/<username>` allows the page to be accessed with a specific user name.  
* The `username` parameter is passed to the `layout` function and used only for constructing
  navigation links.

---

## 3. Layout Function

```python
def layout(username=None):
    ...
```

### 3.1 Data Preparation

```python
recents = postgres.select_recent_songs(0)
number_of_recent_songs = len(recents)
page_size = 50
number_of_pages = math.ceil(number_of_recent_songs / page_size)
```

* Retrieves all recent songs (starting at index 0).  
* Calculates how many pages are needed for a table that shows 50 songs per page.

### 3.2 Navigation Bar

```python
navbar = dbc.NavbarSimple(
    children=[
        dbc.NavItem(dbc.NavLink("Liked Songs", href=f'http://localhost:8050/liked/{username}', id='LikedSongs')),
        dbc.NavItem(dbc.NavLink("Recents", href=f'http://localhost:8050/recents/{username}', id="Recents")),
        dbc.NavItem(dbc.NavLink("Analytics", href=f'http://localhost:8050/analytics/{username}', id="Analytics")),
        dbc.NavItem(dbc.NavLink("Back", href=f'http://localhost:8050/tools/{username}', id="Back"))
    ],
    brand="Spotify Analyzer",
    brand_href="http://localhost:8050/",
    className='box-form left'
)
```

* Consistent with the other pages (`liked_songs`, `analytics`, `tools`).  
* Uses the `username` to build absolute URLs for navigation.

### 3.3 Pagination Slider

```python
html.Div(
    [dcc.Slider(
        id='Pagination',
        min=1,
        max=number_of_pages,
        step=1,
        value=1,
        marks={i: str(i) for i in range(1, number_of_pages + 1)}
    )],
    style={'margin': '0 40px'}
)
```

* A `dcc.Slider` that lets the user pick a page number.  
* `marks` provide a label for each page.

### 3.4 Table Placeholder

```python
html.Div(children=[], id='recents_table', style={'margin': '0 40px'})
```

* The table is rendered by the callback and inserted into this div.

### 3.5 Final Layout

```python
return html.Div([
    navbar,
    slider_div,
    table_placeholder
], style={})
```

* The outer `Div` contains the navbar, slider, and table placeholder.

---

## 4. Callback – Pagination

```python
@callback(
    Output('recents_table', 'children'),
    [Input('Pagination', 'value')],
    [State('Pagination', 'max')]
)
def pages(active_page, max):
    ...
```

### 4.1 Query Logic

```python
if active_page == max:
    recent_songs = postgres.select_recent_songs(active_page * 50 - 50)
else:
    recent_songs = postgres.select_recent_songs(active_page * 50 - 50, active_page * 50)
```

* `select_recent_songs(beg, end)` returns a slice of the recent songs table.  
* When the user is on the last page, the end index is omitted (`'all'` by default).  
* The slice boundaries are calculated as `(page-1)*50` to `page*50`.

### 4.2 DataFrame Construction

```python
column_names = ['song_id', 'SONG', 'ALBUM', 'ARTISTS', 'POPULARITY', 'preview_url']
df = pd.DataFrame(recent_songs, columns=column_names)
df = df.drop(['song_id', 'preview_url'], axis=1)
```

* The raw tuples are turned into a `pandas.DataFrame`.  
* `song_id` and `preview_url` are dropped because they are not needed for display.

### 4.3 Table Rendering

```python
return dbc.Table.from_dataframe(
    df,
    striped=True,
    bordered=True,
    hover=True
)
```

* Uses `dash_bootstrap_components` to create a styled table directly from the DataFrame.  
* The table is returned as the child of the `recents_table` div.

---

## 5. Interaction Flow

1. **User navigates** to `/recents/<username>`.  
2. `layout` builds the page with a navigation bar, a slider, and an empty table placeholder.  
3. The slider’s default value is `1`.  
4. The callback `pages` is triggered with `active_page=1`.  
5. `pages` queries the database for the first 50 recent songs, builds a DataFrame, and renders a table.  
6. When the user moves the slider, the callback runs again with the new page number, updating the table.

---

## 6. Summary of Key Points

| Feature | Implementation | Notes |
|---------|----------------|-------|
| **Page registration** | `dash.register_page` | Dynamic route `/recents/<username>` |
| **Navigation bar** | `dbc.NavbarSimple` | Links use absolute URLs with the supplied `username` |
| **Pagination** | `dcc.Slider` | 1‑based page numbers, 50 items per page |
| **Data source** | `postgres.select_recent_songs` | Returns tuples from the `recent_songs` table |
| **Table rendering** | `dbc.Table.from_dataframe` | Excludes `song_id` and `preview_url` |
| **Dependencies** | `dash`, `dash_bootstrap_components`, `pandas`, `math`, `postgres` | Core functionality and DB access |

> **Used by** – The module itself is not referenced by other modules in the provided evidence, but it is part of the Dash application’s page set and is rendered when a user visits the `/recents/<username>` route.

---

### File Path Reference

All code snippets above are taken from `/app/cloned_repos/spotify_data/pages/recents.py`.  
The module’s public API consists of the `layout` function (page layout) and the `pages` callback (pagination logic).