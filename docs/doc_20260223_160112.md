# `postgres.py` – PostgreSQL Helper Module  
**File path:** `/app/cloned_repos/spotify_data/postgres.py`

The `postgres` module centralises all interactions with the local PostgreSQL database that stores Spotify data.  
It is the single point of truth for creating tables, inserting data, and querying analytics.  
All other pages (`pages.analytics`, `pages.cred`, `pages.liked_songs`, `pages.recents`) import this module to perform database operations.

---

## External Dependencies
| Dependency | Why it is needed |
|------------|------------------|
| `psycopg2` | Low‑level PostgreSQL driver used to open a connection and execute SQL statements. |
| `psycopg2.extras.execute_values` | Bulk‑insert helper that efficiently inserts many rows with a single `INSERT … VALUES %s` statement. |

---

## Core Functions

| Function | Purpose | Key SQL files | Notes |
|----------|---------|---------------|-------|
| `postgres_init(db='postgres', user='postgres', pw='admin', host='localhost', port='5432')` | Opens a new database connection using the supplied credentials. | – | Returns a `psycopg2` connection object. |
| `create_liked_songs_table()` | Creates the `liked_songs` table. | `sql/create_liked_songs.sql` | Commits the transaction and closes the connection. |
| `create_recent_songs_table()` | Creates the `recents` table. | `sql/create_recent_songs.sql` | – |
| `create_album_table()` | Creates the `album` table **and** returns all rows. | `sql/create_album_table.sql`, `sql/select_all_albums.sql` | Returns a list of tuples representing all albums. |
| `create_artist_table()` | Creates the `artist` table. | `sql/create_artist_table.sql` | – |
| `select_unique_artists()` | Retrieves all distinct artist IDs from the `artist` table. | `sql/select_unique_artist_ids.sql` | Returns a list of tuples. |
| `check_liked_songs(table)` | Checks the most recent `added_at` timestamp in the given table (`liked_songs` or `recents`). | – | Returns `(timestamp, True)` if a row exists, otherwise `(None, False)`. |
| `add_liked_songs_dict(songs, table)` | Bulk‑inserts a list of song dictionaries into the specified table. | – | Uses `execute_values` for performance. |
| `add_albums_dict(albums)` | Bulk‑inserts a list of album dictionaries into the `album` table. | – | – |
| `add_artists_dict(artists)` | Bulk‑inserts a list of artist dictionaries into the `artist` table. | – | – |
| `select_unique_albums()` | Retrieves all distinct album IDs from the `album` table. | `sql/select_unique_album_ids.sql` | – |
| `select_liked_songs(beg, end='all')` | Returns a slice of the `liked_songs` view. | `sql/view_liked_songs.sql` | If `end='all'`, returns all rows from `beg` onward. |
| `select_recent_songs(beg, end='all')` | Returns a slice of the `recents` view. | `sql/view_recents.sql` | – |
| `get_years()` | Returns all distinct years present in the data. | `sql/get_years.sql` | – |
| `get_albums_for_year(year)` | Returns albums released in the specified year. | `sql/get_albums.sql` | The SQL string is formatted with the year. |
| `get_popular_for_year(year, flag)` | Returns the most or least popular songs for each month of the given year. | `sql/get_popular.sql` | `flag` is either `'asc'` or `'desc'`. The function loops over all 12 months, aggregates results, and returns a flat list. |

> **Note:**  
> All functions open a new connection, perform the operation, commit (if needed), and close the connection.  
> No connection pooling is used; this is acceptable for the small, local workload of the application.

---

## How Other Modules Use `postgres`

| Module | Usage Pattern | What it relies on |
|--------|---------------|-------------------|
| `pages.cred` | *During login* – creates tables, checks for new data, inserts new records. | `create_*_table`, `check_liked_songs`, `add_*_dict` |
| `pages.liked_songs` | *Page rendering* – fetches a slice of liked songs to display. | `select_liked_songs` |
| `pages.recents` | *Page rendering* – fetches a slice of recent songs to display. | `select_recent_songs` |
| `pages.analytics` | *Analytics UI* – populates dropdowns and graphs. | `get_years`, `get_albums_for_year`, `get_popular_for_year` |

Each page imports the module simply as:

```python
import postgres
```

and then calls the required functions. No other modules import `psycopg2` directly; all database logic is encapsulated here.

---

## Example Usage

```python
# Create tables once (e.g., during app startup)
postgres.create_liked_songs_table()
postgres.create_recent_songs_table()
postgres.create_album_table()
postgres.create_artist_table()

# Insert new liked songs
new_songs = [
    {
        'song_id': '123',
        'song_name': 'Hello',
        'added_at': '2024-02-01T12:00:00',
        'album': 'album_id',
        'popularity': 80,
        'preview_url': 'http://...',
        'duration_ms': 210000,
        'artists': 'artist_id'
    },
    # ... more songs
]
postgres.add_liked_songs_dict(new_songs, 'liked_songs')

# Retrieve analytics
years = postgres.get_years()                     # e.g., [(2022,), (2023,)]
albums_2023 = postgres.get_albums_for_year(2023) # list of (album_name, song_count)
popular = postgres.get_popular_for_year(2023, 'desc')
```

---

## Summary of Responsibilities

- **Connection Management:** `postgres_init` centralises connection creation.
- **Schema Creation:** `create_*_table` functions load SQL from the `sql/` directory.
- **Data Insertion:** `add_*_dict` functions use bulk inserts for efficiency.
- **Data Retrieval:** `select_*` and `get_*` functions expose the data needed by the UI.
- **Analytics Support:** `get_years`, `get_albums_for_year`, and `get_popular_for_year` provide the data required for the analytics page.

All interactions are intentionally simple and synchronous, which keeps the module easy to understand and maintain.