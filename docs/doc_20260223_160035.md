# `liked_songs.py` – Documentation

**File path**: `/app/cloned_repos/spotify_data/pages/liked_songs.py`  
**Module name**: `pages.liked_songs`  
**Purpose**: Provides a Dash page that displays a user’s liked songs in a paginated table.

---

## Overview

| Feature | Description |
|---------|-------------|
| **Page registration** | `dash.register_page(__name__, path_template='/liked/<username>')` registers the module as a Dash page that can be accessed via `/liked/<username>`. |
| **Layout** | `layout(username=None)` builds the page layout: a navigation bar, a pagination slider, and a table placeholder. |
| **Pagination** | Uses a `dcc.Slider` to select the page number. The slider’s range is calculated from the total number of liked songs. |
| **Data source** | Data is fetched from a PostgreSQL database via the `postgres.select_liked_songs` function. |
| **Table rendering** | A `dash_bootstrap_components.Table` is created from a `pandas.DataFrame` of the selected page’s songs. |

---

## Imports & Dependencies

| Import | Reason / Functionality |
|--------|------------------------|
| `dash` | Core Dash framework. |
| `dash.callback` | Decorator for callbacks. |
| `dash.dcc` | Dash Core Components (e.g., `Slider`). |
| `dash.dependencies` (`Input`, `Output`, `State`) | Callback wiring. |
| `dash.html` | HTML components (e.g., `Div`). |
| `dash_bootstrap_components` (`dbc`) | Bootstrap‑styled components (`NavbarSimple`, `Table`). |
| `math` | `math.ceil` for page count calculation. |
| `pandas` (`pd`) | DataFrame creation and manipulation. |
| `postgres` | Custom module that provides `select_liked_songs`. |

> **Why the dependency on `postgres` exists**  
> The page needs to read the user’s liked songs from the database. `postgres.select_liked_songs` returns a list of tuples representing rows from the `liked_songs` table. All other modules that interact with the database (e.g., `pages.cred`) also use this module, but `liked_songs.py` is the only consumer in the provided evidence.

---

## Page Registration

```python
dash.register_page(__name__, path_template='/liked/<username>')
```

* Registers this module as a Dash page.  
* The URL pattern `/liked/<username>` allows the page to be accessed with a dynamic username segment.  
* The `username` parameter is passed to the `layout` function.

---

## Layout Function

```python
def layout(username=None):
    liked_songs = postgres.select_liked_songs(0)
    number_of_liked_songs = len(liked_songs)
    page_size = 50
    number_of_pages = math.ceil(number_of_liked_songs / page_size)

    navbar = dbc.NavbarSimple(
        children=[
            dbc.NavItem(dbc.NavLink("Liked Songs", href=f'http://localhost:8050/liked/{username}', id='LikedSongs')),
            dbc.NavItem(dbc.NavLink("Recents", href=f'http://localhost:8050/recents/{username}', id="Recents")),
            dbc.NavItem(dbc.NavLink("Analytics", href=f'http://localhost:8050/analytics/{username}', id="Analytics")),
            dbc.NavItem(dbc.NavLink("Back", href=f'http://localhost:8050/tools/{username}', id="Back"))
        ],
        brand="Spotify Analyzer",
        brand_href="http://localhost:8050/",
        className='box-form left'
    )

    return html.Div([
        navbar,
        html.Div([dcc.Slider(id='Pagination', min=1, max=number_of_pages, step=1, value=1,
                             marks={i: str(i) for i in range(1, number_of_pages + 1)})],
                 style={'margin': '0 40px'}),
        html.Div(children=[], id='liked_table', style={'margin': '0 40px'})
    ], style={})
```

### Key Points

| Element | Purpose |
|---------|---------|
| `liked_songs = postgres.select_liked_songs(0)` | Fetches all liked songs to determine total count. |
| `page_size = 50` | Number of rows per page. |
| `number_of_pages = math.ceil(number_of_liked_songs / page_size)` | Calculates how many pages are needed. |
| `navbar` | Navigation bar with links that preserve the `username`. |
| `dcc.Slider` (`id='Pagination'`) | Allows the user to choose a page number. |
| `html.Div(id='liked_table')` | Placeholder where the table will be rendered by the callback. |

---

## Callback – Pagination

```python
@callback(
    Output('liked_table', 'children'),
    [Input('Pagination', 'value')],
    [State('Pagination', 'max')]
)
def pages(active_page, max):
    column_names = ['song_id', 'SONG', 'ALBUM', 'ARTISTS', 'POPULARITY', 'preview_url']

    if active_page == max:
        liked_songs = postgres.select_liked_songs(active_page * 50 - 50)
    else:
        liked_songs = postgres.select_liked_songs(active_page * 50 - 50, active_page * 50)

    df = pd.DataFrame(liked_songs, columns=column_names)
    df = df.drop(['song_id', 'preview_url'], axis=1)
    return dbc.Table.from_dataframe(df, striped=True, bordered=True, hover=True)
```

### How It Works

1. **Inputs**  
   * `active_page` – Current slider value (page number).  
   * `max` – Maximum slider value (total pages).  

2. **Data Retrieval**  
   * Calls `postgres.select_liked_songs(beg, end)` to fetch the slice of rows for the requested page.  
   * `beg = active_page * 50 - 50` (offset).  
   * If the requested page is the last page (`active_page == max`), the `end` argument is omitted, so all remaining rows are returned.

3. **DataFrame Construction**  
   * Builds a `pandas.DataFrame` with the specified column names.  
   * Drops the `song_id` and `preview_url` columns because they are not needed for display.

4. **Table Rendering**  
   * Uses `dbc.Table.from_dataframe` to create a Bootstrap‑styled table.  
   * The table is returned as the `children` of the `liked_table` div.

---

## Interaction Flow

1. **User navigates** to `/liked/<username>`.  
2. Dash calls `layout(username)` to build the page.  
3. The slider is rendered with a range based on the total number of liked songs.  
4. When the user moves the slider, the `pages` callback is triggered.  
5. The callback fetches the appropriate slice of data from the database, builds a DataFrame, and renders a table.  
6. The table is displayed inside the `liked_table` div.

---

## External Dependencies

| Dependency | Purpose |
|------------|---------|
| `dash` | Core framework for building the app. |
| `dash.callback` | Decorator for defining callbacks. |
| `dash.dcc` | Core components (e.g., `Slider`). |
| `dash.dependencies` (`Input`, `Output`, `State`) | Wiring inputs/outputs for callbacks. |
| `dash.html` | HTML components (`Div`, etc.). |
| `dash_bootstrap_components` (`dbc`) | Bootstrap‑styled components (`NavbarSimple`, `Table`). |
| `math` | `ceil` for pagination calculation. |
| `pandas` (`pd`) | DataFrame handling for table rendering. |
| `postgres` | Database access (`select_liked_songs`). |

---

## Notes on Usage

* **No direct imports**: The evidence shows that no other module imports `pages.liked_songs` directly (`used_by` is empty).  
* **Page registration**: The module registers itself as a Dash page; the Dash app automatically discovers it.  
* **Username handling**: The `username` parameter is only used to build the navigation links; it does not affect data retrieval (the database queries are global).  
* **Pagination logic**: The page size is hard‑coded to 50 rows. If the number of liked songs changes, the slider range updates automatically.  
* **Data integrity**: The callback drops `song_id` and `preview_url` before rendering; these fields are not displayed but are still stored in the database.

---

## Summary

`liked_songs.py` is a self‑contained Dash page that:

1. **Registers** itself under `/liked/<username>`.  
2. **Builds** a navigation bar and a pagination slider.  
3. **Fetches** liked songs from a PostgreSQL database via `postgres.select_liked_songs`.  
4. **Displays** the selected page of songs in a Bootstrap table.

All interactions are driven by Dash callbacks, and the module relies on `pandas` for data manipulation and `dash_bootstrap_components` for styling.