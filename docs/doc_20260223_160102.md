# `analytics.py` – Documentation

**File path**  
`/app/cloned_repos/spotify_data/pages/analytics.py`

---

## 1. Overview

`analytics.py` implements the **Analytics** page of the Spotify Analyzer web application.  
It is a Dash page that:

1. Shows a navigation bar with links to the other pages (`Liked Songs`, `Recents`, `Analytics`, `Back`).
2. Provides a dropdown to select a year.
3. Dynamically displays:
   * The top 3 albums for the selected year.
   * A bar chart of the most popular songs per month.
   * A bar chart of the least popular songs per month.

The page is registered with Dash using `dash.register_page` and is reachable at the URL pattern  
`/analytics/<username>`.

---

## 2. Imports & External Dependencies

| Import | Purpose |
|--------|---------|
| `dash` | Core Dash framework. |
| `dash.html` | HTML component constructors (`html.Div`, `html.H1`, etc.). |
| `dash.dcc` | Dash Core Components (`dcc.Dropdown`, `dcc.Graph`). |
| `dash_bootstrap_components` | Bootstrap‑styled components (`dbc.NavbarSimple`, `dbc.NavItem`, `dbc.NavLink`, `dbc.Table`). |
| `dash.dependencies` | `Input`, `Output` for callbacks. |
| `pandas` | Data manipulation (creating `DataFrame` for the album table). |
| `postgres` | Custom module that provides database access functions (`get_years`, `get_albums_for_year`, `get_popular_for_year`). |

> **Why these dependencies exist**  
> *Dash* and *dash_bootstrap_components* are required to build the UI.  
> *pandas* is used to convert raw album data into a `DataFrame` that can be rendered as a table.  
> The `postgres` module supplies the analytics data stored in the PostgreSQL database.

---

## 3. Page Registration

```python
dash.register_page(__name__, path_template='/analytics/<username>')
```

* Registers this module as a Dash page.  
* The `<username>` part of the URL is passed to the `layout` and callback functions as the `username` argument.

---

## 4. Layout Function

```python
def layout(username=None):
    years = list(postgres.get_years())
    ...
    return html.Div([...])
```

### What it does

1. **Fetch Years** – Calls `postgres.get_years()` to obtain the list of years for which data exists.  
2. **Navbar** – Builds a Bootstrap navbar with links that include the current `username`.  
3. **Year Dropdown** – A `dcc.Dropdown` populated with the years (first element of each tuple returned by `get_years`).  
4. **Target Div** – An empty `html.Div` (`id='target_div'`) that will be filled by the callback.

### Interaction

* The `layout` function is invoked by Dash when the user navigates to `/analytics/<username>`.  
* The `username` argument is used only to construct the navigation links; it does not affect the analytics data itself.

---

## 5. Callback – `analytics_display`

```python
@callback(
    Output('target_div', 'children'),
    [Input('year_drop', 'value')]
)
def analytics_display(value):
    ...
```

#### Trigger

* Fires whenever the user selects a year from the dropdown (`year_drop`).

#### Logic

1. **No Year Selected**  
   * Returns an `html.H1` prompting the user to choose a year.

2. **Year Selected**  
   * **Albums** – `postgres.get_albums_for_year(value)` returns a list of tuples `(album_name, song_count)`.  
   * **Most Popular Songs** – `postgres.get_popular_for_year(value, 'desc')` returns a list of tuples where the 5th element is the month.  
     * Builds a bar chart (`most_popular`) with 12 bars (one per month).  
     * The bar height is `popularity * 10 + 100` (arbitrary scaling).  
     * The bar text shows the song name.  
   * **Least Popular Songs** – Same as above but with `'asc'` flag to get least popular songs.  
   * **Album Table** – Converts the album list into a `pandas.DataFrame` and renders it with `dbc.Table.from_dataframe`.  
   * **Return** – A list of components: heading, table, most popular graph, least popular graph.

#### Why this callback exists

* It connects the UI (dropdown) to the backend data (PostgreSQL) and renders the analytics visualisations.  
* Keeps the page responsive: only the `target_div` is updated, not the whole page.

---

## 6. Dependencies Explained

| Dependency | Where it is used | What it provides |
|------------|------------------|-------------------|
| `postgres` | `layout` (to get years) and `analytics_display` (to get albums & popularity data) | Database query functions (`get_years`, `get_albums_for_year`, `get_popular_for_year`) |
| `dash` | Page registration, callback decorator | Core Dash framework |
| `dash.html` | Building the navbar, headings, divs | HTML component constructors |
| `dash.dcc` | Dropdown, Graph components | Interactive UI components |
| `dash_bootstrap_components` | Navbar, table | Bootstrap‑styled components |
| `dash.dependencies` | `Input`, `Output` | Callback wiring |
| `pandas` | Converting album list to DataFrame | Data manipulation & table rendering |

> **Missing relationships** – None. All dependencies are explicitly listed in the evidence.

---

## 7. Interaction with Other Modules

* **`pages.cred`** – The `cred` page calls `fetch_data` which populates the database tables that `analytics.py` reads from.  
* **`pages.liked_songs` & `pages.recents`** – These pages also use the same `postgres` functions to display data, but they do not directly interact with `analytics.py`.  
* **`postgres`** – Provides the only data source for analytics; all queries are executed through this module.

---

## 8. Usage Summary

1. User navigates to `/analytics/<username>`.  
2. `layout` renders the navbar, dropdown, and an empty `target_div`.  
3. User selects a year → `analytics_display` callback runs.  
4. Callback fetches data from PostgreSQL, builds graphs and a table, and updates `target_div`.  
5. The page displays the analytics for the chosen year.

---

## 9. Notes

* The callback returns a **list of Dash components**; Dash automatically renders them inside the `target_div`.  
* The bar chart heights use a simple scaling (`popularity * 10 + 100`) – this is arbitrary and can be adjusted for better visual balance.  
* The code assumes that the PostgreSQL queries return data in the expected tuple format; any change in the database schema would require updates to the callback logic.

---